---
title: "Structural Equation Modeling in R"
author: "Marlon Schumacher"
date: '2018-10-24'
slug: structural-equation-modeling-in-r
categories:
  - R
  - Tutorial
tags:
  - SEM
  - Structural Equation Modeling
  - lavaan
  - semplot
  - fit indices
image:
  caption: ''
  focal_point: ''
bibliography: bibliography_001.bib 
csl: mcstatistics.csl
output: 
  blogdown::html_page:
    toc: true
---

## lavaan: A Package for SEM
In my pervious post I made a [short introduction to Structural Equation Modeling (SEM)](https://www.mcstatistics.eu/post/structural-equation-modeling-a-short-introduction/). But now it's about using R for SEM. However, to use R for SEM we need the package `lavaan`. For the visualization of the models we also need the package `semPlot`. As you probably know already the installation of the packages is very simple:

```{r eval = FALSE}
install.packages("lavaan")
install.packages("semPlot")
```

## Syntax for Modelling
The modely syntax of lavaan is used for specifying a SEM. There are three operators for model specification:

+ `=~` is used to specify latent variables/factors
+ `~~` is used to specify (residual) (co)variances
+ `~`  is used to specify rgeression

So kann mit diesen Operatoren folgendes Beispielmodell spezfiziert werden:

```{r}
example <- "
# measurement model
F1 =~ 1*V1 + V2 + V3
F2 =~ 1*V4 + V5 + V6

# (residual) (co)variances
V1 ~~ V1 # variance
V1 ~~ V3 # residual correlation

# regressions
F1 ~ F2"
```

## Model Fitting
Now, let's specify the first model. I will use an own dataset from a previous work. It's also possible to use the built-in datasets `HolzingerSwineford1939` or `PolitcialDemocracy` from lavaan to become familiar with the package. Moreover, the functions `cfa()` and `sem()` are currently similar but they may differ in the future. It's also possible to use one of the robust estimators, if you're fitting the model.

```{r message=FALSE, warning=FALSE, include=FALSE}
load("allbus_imp.RData")
library(magrittr)
library(tidyverse)
library(lavaan)
data <- allbus_imp %>% 
  select(-age, -sex, -work, -mc04)

colnames(data) <- c("X1", "X2", "X3", "X4", "X5", "X6", "Y1", "Y2", "Y3", "Y4", "weight")

model <- "
# measurement model
F1 =~ 1*X1 + X2 + X3 + X4 + X5 + X6
F2 =~ 1*Y1 + Y2 + Y3 + Y4

# regression
F1 ~ F2"

# fitting the model
fit <- cfa(model, data = data)

# summary of the fit with standardized values and fit measurements
summary(fit, standardized = T, fit.measures = T)
```


```{r}
library(lavaan)
model <- "
# measurement model
F1 =~ 1*X1 + X2 + X3 + X4 + X5 + X6
F2 =~ 1*Y1 + Y2 + Y3 + Y4

# regression
F1 ~ F2"

# fitting the model
fit <- cfa(model, 
           data = data,
           estimator = "MLM") # robust estimator 

# summary of the fit with standardized values and fit measurements
summary(fit, standardized = T, fit.measures = T)
```

If you want to select specific fit measurements, you can use the function `fitmeasures()`. By using the command `fit.measures = "all"` you will get all available fit measures.

```{r}
fitmeasures(fit, fit.measures = c("chisq", "cfi", "rmsea", "srmr"))
```

## (Standardized) Estimated Parameter Change
To identify potential model misspecification, you can use `modificationindices()`. If the SEPC is $\geq.20$, there may be a possible misspecification. However, adjustments to the model should be based on a theoretical justification.

```{r}
# first 10 rows as output & sorting by mi-value
head(modificationindices(fit, sort. = T), 10)
```

